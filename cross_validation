clear all;close all;clc

%% This code takes as 
% - input the measurments from the IRF and TO2 analysis
% - Divide the data into leave-one out fashion
% - Computes the correlation coeff between IRF and TO2 on training data
% - Fit a polynomial to training data
% - Predict TO2 for gievn test data IRF 
% - Report the mean square error (MSE)


%% Input the data for all the cases 
% Note the Case NUmber and Subject number may not be the same since for
% some Cases we have 2 measurements and for others like Case 5 we do not
% include the measurment

% Case 1
Subject{1}.TO2 = [0.6534480048	0.5535223367	0.5477806548	0.6154835888	0.655165097	    0.6344421851	0.6505097116	0.61802727	    0.6712615951	0.6132332752	0.6709543219	0.706883386	    0.698381588	    0.7144377257];
Subject{1}.IRF = [0.0735053119	0.081672906	    0.0795608889	0.0878289422	0.0918857596	0.1025891182	0.1088650951	0.0875948488	0.1006902801	0.1293698514	0.1454491438	0.1951525586	0.2030593454	0.2043644508];

%Case #2 Colon
Subject{2}.TO2 = [0.7378885148	0.742481994 	0.7234921261	0.7520830962	0.7188665007	0.6990644205	0.6619160382	0.6010642852	0.496007136	    0.4024936732	0.4716258119	0.375996684];
Subject{2}.IRF = [0.2800508758	0.3217819399	0.3353304671	0.3421880122	0.3153775482	0.2071791693	0.1014280914	0.0337783736	0.0229663671	0.0176024122	0.0146847471	0.0119886237];

% Case 2 small bowel
Subject{3}.TO2 = [0.7890849281	0.7171018384	0.7711748311	0.7510322747	0.7208707972	0.6784889477	0.6368872182	0.5571269328	0.50845673   	0.5469829157	0.4656349359	0.4171423217	0.3978470208];
Subject{3}.IRF = [0.3251021696	0.322334765	    0.3026950124	0.2881612288	0.2357141555	0.1739586181	0.1020167059	0.0518264276	0.0249633154	0.017440879	    0.0158217628	0.0171278518	0.0174195291];

%Case #3
Subject{4}.TO2 = [0.7500647033	0.7266283778	0.7523789712	0.7609557555	0.7038037983	0.6802623476	0.6518512504	0.6035720528	0.4921058611	0.4423445232	0.4591921841	0.5186366731	0.5903897682	0.6410992161	0.5992334395	0.5558989483];
Subject{4}.IRF = [0.2010823066	0.1916562348	0.1950181099	0.2150028141	0.2198712743	0.2230763145	0.2099492599	0.1671047025	0.1597299286	0.187615401	    0.2014073253	0.2020632528	0.1936256208	0.2091458657	0.1673785721	0.160449206];

% Case #4
%Subject{}.TO2 = [0.8697996941	0.8655087807	0.7952926459	0.83392383	    0.8254050247	0.8820448076	0.802331378	    0.8331455921	0.9099404025	0.8384991181	0.9038458387	0.8669833849	0.8904097878	0.8664394799	0.8880262891	0.9102605786	0.9317668298	0.854863432  	0.9167530969	0.9105081697	0.9420986957];
%Subject{}.IRF = [0.0894154586	0.0754036859	0.0594454805	0.0354638372	0.0312081033	0.0280684028	0.0295237136	0.0303026114	0.0279456197	0.0256973121	0.0276960797	0.0248819022	0.0248593791	0.0272365485	0.0267100936	0.0221417843	0.0248663883	0.0252576212	0.0290954429	0.0251617334	0.0180240489];

% Case 6
Subject{5}.TO2 = [0.7547475655	0.792982432	    0.770646248	    0.6993798808	0.848604929	    0.7858915984	0.7814829586];
Subject{5}.IRF = [0.1747140847	0.2091950346	0.2491337825	0.2783334398	0.3336069298	0.3767188554	0.3852793645];

% Case 7
Subject{6}.TO2 = [0.5679072075	0.7078951569	0.6025609814	0.6102122088	0.5756400901	0.6371566527	0.7163140728	0.711687537	    0.7276379151	0.76239663   	0.7992834979	0.7582161375	0.7634704449	0.8099059894	0.7310259301	0.3651674279	0.6860700453	0.7555209984	0.7589830895	0.7675261886	0.7750404356	0.7497825056	0.682495587	    0.6776484724];
Subject{6}.IRF = [0.0926578834	0.0988317667	0.1008748035	0.0976160051	0.0939546139	0.1035885508	0.118212898	    0.1637170691	0.1976179231	0.2168429042	0.2169039443	0.2119040723	0.2209949788	0.1873674928	0.2024584009	0.1993017701	0.1977250135	0.1920503936	0.1995600841	0.1873668778	0.1780208658	0.1882361139	0.1818384053	0.1842933118];

% Case 8
Subject{7}.TO2 = [0.7405048372	0.7247081556	0.7342881298	0.7173139595	0.7382856486	0.7837006813	0.7296366029	0.7848744505	0.7684123877	0.7807942421	0.7932085381	0.7836374556	0.79115701];
Subject{7}.IRF = [0.1472322664	0.1762321483	0.1873594828	0.1994934182	0.2004592652	0.2120919831	0.2381097794	0.2484280772	0.2624284034	0.2807696964	0.2625560511	0.235648902	0.2234203092];

% Case 9 
Subject{8}.TO2 = [0.696917047	0.742893277	0.800897585	0.82321607	0.806403441	0.827640126	0.786533586	0.833125252	0.734395046	0.780630443	0.75903036	0.750899544	0.761155044];
Subject{8}.IRF = [0.102307424	0.148377191	0.151317235	0.164891882	0.162753459	0.146065488	0.117578909	0.205110856	0.23189905	0.233506639	0.229106269	0.228432385	0.221589525];

% Case 13 
Subject{9}.TO2 = [0.446418636	0.538158529	0.55383316	0.564949856	0.483412253	0.584852796	0.492355527	0.629951184	0.609712372	0.691041715];
Subject{9}.IRF = [0.037680068	0.038089121	0.039404935	0.040310988	0.038154162	0.031104123	0.037689866	0.042117769	0.034152068	0.035655384];

% Case 14 
Subject{10}.TO2 = [0.759023611	0.671066198	0.536494591	0.508225584];
Subject{10}.IRF = [0.141821892	0.144704224	0.100161881	0.066194268];

% Case 15 
Subject{11}.TO2 = [0.772609045	0.832611711	0.846088533	0.836150798	0.833129729	0.834127534	0.812753227	0.814190815	0.809070971	0.789024487	0.762835065];
Subject{11}.IRF = [0.263446627	0.261895586	0.350315834	0.393711537	0.39528595	0.368402437	0.31976599	0.375070936	0.384869143	0.373467903	0.369090127];

% Case 17 
Subject{12}.TO2 = [0.482725543	0.514824359	0.684205287	0.682296722	0.666706512	0.701115658	0.689193264	0.651994199	0.653990488	0.637687483	0.543637421	0.527138722	0.56411655	0.556940057	0.534151672	0.516386407	0.582135047	0.550083064	0.576785197	0.571254274];
Subject{12}.IRF = [0.033619128	0.063673156	0.068391283	0.09328602	0.109425408	0.129293882	0.123019458	0.124972358	0.089151105	0.050099813	0.022386212	0.016115394	0.013343946	0.014144517	0.011986255	0.012599512	0.011822131	0.010590338	0.009708496	0.010025133];

% Case 18 
Subject{13}.TO2 = [0.706826864	0.740308957	0.705978529	0.683274404	0.643273967	0.654517004	0.652589926	0.668908602	0.670876811	0.693895141	0.64954012	0.619760111	0.611502429	0.611423736	0.620831703	0.60140076	0.682419405	0.737127325	0.707045274];
Subject{13}.IRF = [0.088113154	0.108450339	0.127834765	0.128672155	0.133292764	0.13007485	0.141744833	0.129815917	0.120166181	0.117434428	0.112200391	0.07650682	0.061520051	0.043647872	0.038364498	0.03170565	0.031159232	0.032060902	0.026379701];

% Case 19 
Subject{14}.TO2 = [0.72661084	0.779014273	0.794668605	0.807536003	0.844171716	0.814854634	0.768023077	0.775530483	0.739834923	0.717175927	0.705559173	0.676361859	0.661919941	0.539634346	0.581548058];
Subject{14}.IRF = [0.055556161	0.064548704	0.084195318	0.084308826	0.101319764	0.097553511	0.090382619	0.090333511	0.087717903	0.07955036	0.070422438	0.06800508	0.073927563	0.068940188	0.071025735];


%% INPUTS 
leave_no = ; % Subject number that you want to use for validation. Note subject no. and case no. are different.
Poly_degree = 2; % The degree of polynomial that you want to fit. If 1, a line will be fit. 

%%
TO2_all = [];
IRF_all = [];
% Split data into training and validation
for i = 1: length(Subject)
    if i == leave_no
        TO2_measured_testset = Subject{i}.TO2;
        IRF_measured_testset = Subject{i}.IRF;
    else
    TO2_all = [TO2_all Subject{i}.TO2];
    IRF_all = [IRF_all Subject{i}.IRF];
    end
end
Xcorr = corrcoef(IRF_all,TO2_all);   % Correlation Coefficient
Xcorr = Xcorr(1,2)

%% Polyfit
poly_fit = polyfit(IRF_all,TO2_all,Poly_degree);  
TO2_predict_testset = polyval(poly_fit,IRF_measured_testset);   % Predicted TO2 given IRF from leave_no samples

% For ploting the fitted polynomial
x_steps = min(IRF_all):0.05:max(IRF_all);
y_pred_steps = polyval(poly_fit,x_steps);

figure;
plot(x_steps, y_pred_steps, 'b', 'LineWidth',2); hold on;  % fitted polynomial
plot(IRF_all, TO2_all, 'o', 'MarkerSize',5, 'LineWidth',2)  % train samples 
hold on;
plot(IRF_measured_testset, TO2_measured_testset, 'ro', 'MarkerSize',5, 'LineWidth',2) % test samples measured values
plot(IRF_measured_testset, TO2_predict_testset, 'go', 'MarkerSize',5, 'LineWidth',2)  % test samples predicted values
legend ({'Polyfit','Train\_measurments','test\_TO2\_measured','Test\_TO2\_predicted'}, 'Location','southeast')

MSE = mean((TO2_measured_testset - TO2_predict_testset).^2) % mean square error
